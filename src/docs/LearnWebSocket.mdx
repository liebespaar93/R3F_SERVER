---
title: LearnWebSocket.mdx
description: |-
 websocketì— ëŒ€í•œ ë‚´ìš©ì…ë‹ˆë‹¤
date: 2024-03-29T18:26:21Z
preview: ì´ë¯¸ì§€ ì£¼ì†Œ
draft: false
tags:
 - websocket
categories:
 - websocket
---


## Websocket ì´ë€?

![Image](/docs/LearnWebSocket/socket_key_bind.gif)

ì›¹ì—ì„œ [http protocol](https://datatracker.ietf.org/doc/html/rfc9114) ë‹¨ë°©í–¥ ê·œê²© í†µì‹ ì´ ì•„ë‹Œ\
http ê·œê²©ì—ì„œ ë²—ì–´ë‚  ìˆ˜ ìˆìœ¼ë©° í´ë¼ì´ì–¸íŠ¸ì— ëŒ€í•œ ì •ë³´ê°€ ìˆê¸° ë•Œë¬¸ì— ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ê°€ ì§€ì†ì ìœ¼ë¡œ í†µì‹  í•  ìˆ˜ ìˆë‹¤ëŠ” ì¥ì ì„ ë‘” í†µì‹  ë°©ë²•ì´ë‹¤\
ì •ë§ ê°„ë‹¨í•œ êµ¬ì¡°ë§Œì„ ê°€ì§€ê³  tcp í†µì‹ ì„ í•œë‹¤ê³  ìƒê° í•˜ë©´ ì¢‹ë‹¤.

> [!TIP]
> í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ëŠ” í•˜ìœ„ì˜ í•´ë”ë¥¼ ê°€ì§€ê³  TCP í†µì‹ ì„ ì§„í–‰í•œë‹¤

í´ë¼ì´ì–¸íŠ¸
```bash
{
  GET /chat HTTP/1.1
  Host: server.example.com
  Upgrade: websocket
  Connection: Upgrade
  Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
  Origin: http://example.com
  Sec-WebSocket-Protocol: chat, superchat
  Sec-WebSocket-Version: 13
}
```

ì„œë²„
```bash
{
  HTTP/1.1 101 Switching Protocols
  Upgrade: websocket
  Connection: Upgrade
  Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=
  Sec-WebSocket-Protocol: chat
}
```
> [!IMPORTANT]
> http í†µì‹ ì´ ì „í˜€ í•„ìš”ì—†ì„ê¹Œ? <br/>
> socketì„ ì •ìƒì ìœ¼ë¡œ ì—°ê²°ë˜ê¸° ìœ„í•´ http í†µì‹  í”„ë¡œí† ì»¬ì„ ì‚¬ìš©í•œë‹¤

ìì„¸í•œ ì„¤ëª…ì€ RFC ë¬¸ì„œë¥¼ ì°¸ê³ í•˜ê¸¸ ë°”ë€ë‹¤\
ğŸ”— ë§í¬ : [ [rfc6455](https://datatracker.ietf.org/doc/html/rfc6455) ]

### ì‚¬ìš©í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬

í•„ìëŠ” nextjsë¥¼ ì‚¬ìš©í•˜ê³  ìˆì–´ nextjsìš© websocketì¸  ```next-ws```ë¥¼ ì‚¬ìš©í•˜ì˜€ë‹¤.

```bash
npm i next-ws
npm i --save-dev @types/ws
```

### ë¬¸ì œì 
nextjsì˜ ê²½ìš° ì†Œì¼“ì„ clientì™€ serverì— ë°ì´í„°ë¥¼ ì „ë‹¬í•˜ê¸° ìœ„í•˜ì—¬ ë‚´ë¶€ì ìœ¼ë¡œ ì‚¬ìš©ì´ ëœë‹¤.\
í•˜ì§€ë§Œ ê·¸ëŸ¬í•œ ì„œë²„ íŠ¹ì„±ë•Œë¬¸ì— socketì„ í•„ìš”í• ë•Œ ì—´ê³  ë‹«ëŠ” ê¸°ëŠ¥ì´ ìˆëŠ”ë° ì´ëŸ¬í•œ ê¸°ëŠ¥ì„ êº¼ì£¼ëŠ” ```patch```ê°€ í•„ìš”í•˜ë‹¤.\
ì´ë˜í•œ ```next-ws``` ì—ì„œ ì§€ì›í•´ ì£¼ê³  ìˆìœ¼ë©° ì‚¬ìš©ë²•ì€ ë‹¤ìŒê³¼ ê°™ë‹¤

```bash
npm i 
npx next-ws-cli@latest patch
```

> [!WARNING]
> ì´ íŒ¨ì¹˜ë¥¼ í•˜ê³  ë‚œ ë‹¤ìŒì€ vercelì— ì˜¬ë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br/>
> í•„ìš”ì‹œ live serverê°€ ë°°í‘œê°€ëŠ¥í•œ í´ë¼ìš°ë“œ í˜¹ì€ í˜¸ìŠ¤íŠ¸ë¥¼ ì´ìš©í•˜ì„¸ìš”

ì´ì œ ë³¸ê²©ì ì¸ ì½”ë“œë¥¼ ë§Œë“¤ì–´ë³´ì

ğŸ next.config.mjs
```mjs
// next-ws
import { verifyPatch } from 'next-ws/server/index.js'

verifyPatch()
```

ì„¤ì •ì€ nextjsê°€ êµ¬ë™ë˜ê¸°ì „ patchê°€ ì •ìƒì ìœ¼ë¡œ ë˜ì—ˆëŠ”ì§€ ê°ì§€í•œë‹¤.

ì´ì œ í´ë¼ì´ì–¸íŠ¸ì˜ socketì„ react ì²˜ëŸ¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•´ì¤€ë‹¤

í•„ìì˜ ê²½ìš° ```/api/ws```ì„ ì£¼ì†Œë¡œ ì‚¬ìš©í•˜ì˜€ë‹¤

```jsx filename="Provider.tsx"
'use client';

import { WebSocketProvider } from 'next-ws/client';

import React from 'react'
import PropTypes from 'prop-types'

type ProviderProps = {

} & React.PropsWithChildren

function Provider(props: ProviderProps) {
  return (
    <WebSocketProvider
      url={'ws://localhost:' + (process.env.PORT ?? '3000') + '/api/ws'}>
      {props.children}
    </WebSocketProvider>
  )
}

Provider.propTypes = {}

export default Provider
```

ì´ë¥¼ rootlayoutì— ì ìš© ì‹œì¼œì¤€ë‹¤

```jsx filename="layout.tsx"
...

import Provider from "./Provider";

... 

export default function RootLayout({children }: Readonly<{children: React.ReactNode}>) {
  return (
    <html lang="en" className="h-full">
      <body className={'h-full ' + inter.className}>
        <Provider>
          {children}
        </Provider>
      </body>
    </html>
  );
}
```

ì´ë¡œì„œ client ê°€ websocketì„ ì‚¬ìš©í•  ì¤€ë¹„ê°€ ëë‚¬ë‹¤

### socket ì‚¬ìš©ë²•

#### ğŸš€ ì„œë²„ ì‚¬ìš©ë²•

> [!NOTE]
> ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ë¥¼ ì˜ êµ¬ë¶„í•´ ì£¼ì„¸ìš”

ì„œë²„ì˜ ê²½ìš° í•„ìëŠ” ```/api/ws/route.ts```ì— ì‘ì„±í•˜ì˜€ë‹¤ (ì–´ë””ë“  ìƒê´€ì´ ì—†ë‹¤)

ğŸ /api/ws/route.ts
```ts filename="/api/ws/route.ts"
import ws from 'ws'
import http from 'http'

export function SOCKET(
  client: ws.WebSocket,
  request: http.IncomingMessage,
  server: ws.WebSocketServer,
) {
  importantServerLog('A client connected!');

  client.on('open', () => {
    // ì´ê±´ ì‘ë™ì´ ì•ˆí•œë‹¤ SOCKETí•œìˆ˜ ìì²´ê°€ openì˜ ê¸°ëŠ¥ì„ í•˜ëŠ”ê±° ê°™ë‹¤
  })

  client.on('error', () => {
    // errorì— ëŒ€í•œ listener ì„¤ì •ì´ë‹¤
  })

  client.on('close', () => {
    // closeì— ëŒ€í•œ listener ì„¤ì •ì´ë‹¤
  });

  client.on('message', async (message) => {
    // messageì— ëŒ€í•œ listener ì„¤ì •ì´ë‹¤
  });
}

// error ë°©ì§€ìš©
export function GET(req: NextRequest) {
  importantServerLog("api[ws] : ", req)
  return NextResponse.json({
    socket: "next-ws",
    message: "here is for connect WebSocket with next-ws"
  })
}
```

ğŸª„ ì„¤ì • ì˜µì…˜ 

| ì˜µì…˜ | ì„¤ëª… |
| :-: | :-- |
| ```close``` | ì†Œì¼“ì´ ë‹«ì¹ ë•Œ ê°ì§€í•©ë‹ˆë‹¤ |
| ```error```| ì—ëŸ¬ë¥¼ ê°ì§€í•©ë‹ˆë‹¤ |
| ```upgrade``` | ì†Œì¼“ì´ ë³€ê²½ë ë•Œ ê°ì§€í•©ë‹ˆë‹¤ |
| ```message``` | ì†Œì¼“ì˜ ë©”ì„¸ì§€ë¥¼ ë°›ì„ë•Œ ê°ì§€í•©ë‹ˆë‹¤ |
| ```open``` | ì†Œì¼“ì´ ì—´ë¦´ë•Œ ê°ì§€í•©ë‹ˆë‹¤|
| ```ping``` ```pong``` | ìƒíƒœí™•ì¸ì„ ìœ„í•œ í•‘íì„ ê°ì§€í•©ë‹ˆë‹¤ |
| ```unexpected-response```| ë¬´ì–¸ê°€ ã…ˆ ë«ìŒì„ ê°ì§€í•©ë‹ˆë‹¤.|

#### ğŸš€ í´ë¼ì´ì–¸íŠ¸ ì‚¬ìš©ë²•

> [!NOTE]
> ```useWebSocket()```ì„ ì´ìš©í•˜ì—¬ ```ws```ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

```jsx
'use client'
import React, { useCallback, useEffect, useState } from 'react';
import { useWebSocket } from 'next-ws/client';

export default function Page() {
  /*** socket setting start ***/
  const [ws, setWs] = useState<WebSocket | null>(useWebSocket());

  const onOpen = useCallback((ev: Event) => {
    // ì˜¤í”ˆë«ì„ë•Œ ì´ë²¤íŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤
  }, []);

  const onError = useCallback((ev: Event) => {
    // Error ë¥¼ ë°›ì„ë•Œ ì‘ë™ì„ ì‘ì„±í•©ë‹ˆë‹¤
  }, []);

  const onClose = useCallback((ev: CloseEvent) => {
    // close ì†Œì¼“ì´ ë‹«íë•Œ ì‘ë™ì„ ì‘ì„±í•©ë‹ˆë‹¤.
  }, [])

  const onMessage = useCallback(async (ev: MessageEvent<Blob>) => {
    // message ê°€ ìˆ˜ì‹ ë˜ì—ˆì„ë•Œ ì‘ë™ì„ ì‘ì„±í•©ë‹ˆë‹¤.
  }, []);

  useEffect(() => {
    if (ws) {
      ws.addEventListener('open', onOpen)
      ws.addEventListener('message', onMessage);
      ws.addEventListener('error', onError);
      ws.addEventListener('close', onClose);
      return () => {
        ws.removeEventListener('open', onOpen);
        ws.removeEventListener('message', onMessage);
        ws.removeEventListener('error', onError);
        ws.removeEventListener('close', onClose);
      }
    }
  }, [onOpen, onMessage, onError, onClose, ws])

  return (
    <div className=' w-full h-full flex flex-col'>
      ...
    </div>
  )
}
```

ì´ëŸ¬í•œ ì‹ìœ¼ë¡œ ì„œë²„ì™€ í´ë¼ì–¸íŠ¸ê°€ ì—°ê²°ì´ ì˜ ë˜ì•—ëŠ”ì§€ í™•ì¸ì´ ê°€ëŠ¥í•˜ê³  ìƒíƒœì— ë”°ë¥¸ ì„¤ì •ì„ í•´ì¤„ ìˆ˜ ìˆë‹¤.

> [!TIP]
> ```useCallBack() ```ì„ ì™œ ì‚¬ìš©í•˜ë‚˜ìš”? <br/>
> reactì— ë¦¬ë Œë”ë§ í• ë•Œ í•„ìš”ì—†ëŠ” ì¬êµ¬ì„±ì„ í”¼í•˜ê¸°ìœ„í•´ ìµœì í™”ë¼ê³  ìƒê°í•˜ì‹œë©´ ë©ë‹ˆë‹¤.


### socket ì •ë³´ê°€ì ¸ì˜¤ê¸°

ì•ì„œ ì„¤ëª…í–ˆë“¯ì´ socketì— ëŒ€í•œ ì •ë³´ëŠ” í•¸ë“œì‰ì´í‚¹ì¤‘ ì˜¤ê²Œëœë‹¤.

```jsx
export function SOCKET(
  request: http.IncomingMessage,
) {
  console.log(request)
}
```
ì´ request ì•ˆì— ìˆëŠ”ë°

ê°€ì ¸ì˜¤ëŠ” ë°©ë²•ì€ ```request.headers['sec-websocket-key']```


### ë©”ì„¸ì§€ ì‹¤ìŠµ

ì›í•˜ëŠ” ì‘ë™ë°©ì‹ì˜ í•¨ìˆ˜ë“¤ì„ ë§Œë“¤ì–´ ì“°ë©´ ì¢€ë” ê¹”ë”í•œ ì½”ë“œê°€ ëœë‹¤\
ì´ëŸ¬í•œ ì½”ë”© ë°©ì‹ìœ¼ë¡œ ë³€ìˆ˜ ì´ë™ì´ ë¶ˆí¸í•˜ì§€ë§Œ ë‚˜ì¤‘ì— ```redux```ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ìœ¼ë¡œ ì¢€ë” í¸í•˜ê²Œ ì“¸ ìˆ˜ ìˆê²Œ í•˜ë©´ ì¢‹ì„ê±° ê°™ë‹¤

ë¨¼ì € íƒ€ì…ì„ ì •ì˜í•´ ì¤€ë‹¤\
í•„ìëŠ” sendì™€ recvë¥¼ ë”°ë¡œ ë¶„ë¦¬í•˜ì—¬ í˜¼ìš©ë˜ì§€ ì•Šê²Œ í•˜ì˜€ë‹¤. (ë°ì´í„° ë³€í™˜ì´ ìˆì–´ ì†ë„ëŠ” ëŠë¦¬ì§€ë§Œ ë³´ê¸°ê°€ í¸í•˜ë‹¤)\
ì•„ë˜ì™€ ê°™ì€ í˜•ì‹ìœ¼ë¡œ ë§Œë“¤ì–´ ì£¼ê³  ì§„í–‰í•˜ì˜€ë‹¤

```ts
type userInfo = {
  id: string,
  nickname? : string,
  state?: string[],
}

type socketMsg = {
  type: string,
  msg?: string | null
}

type socketSend = {
  sendForm :userInfo
  sendTo? : userInfo
} & socketMsg

type socketRecv = {
  recvFrom: userInfo
} & socketMsg

```

í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì ‘ì†ë˜ë©´ 'omOpen'ì´ë¼ëŠ” íƒ€ì…ì˜ ë©”ì„¸ì§€ë¥¼ ì „ì†¡í•˜ì—¬ serverì— ìˆëŠ” client idë¥¼ ë°›ì•„ì˜¤ê³ \
ì „ë‹¬ë°›ëŠ” 'my_info'ë¼ëŠ” ë©”ì„¸ì§€ë¥¼ ë°›ìœ¼ë©´ userinfoë¥¼ ì—…ë°ì´íŠ¸ í•´ì£¼ì


```jsx
export default function SocketPage() {
  const [ws, setWs] = useState<WebSocket | null>(useWebSocket());
  const [userInfo, setUserInfo] = useState<userInfo>({ id: '', nickname: 'No Nickname' });
  const [userList, setUserList] = useState<userInfo[]>([]);
  const [tryConnect, setTryConnect] = useState(0);

  const onOpen = useCallback((ev: Event) => {
    importantClientLog("onOpen listen", ev);
    if (!ws)
      return;
    ws.send(JSON.stringify({ type: 'onOpen', sendForm: { id: '' } } satisfies socketSend))
    setTryConnect(0);
  }, [ws]);

  const onMessage = useCallback(async (ev: MessageEvent<Blob>) => {
    importantClientLog("onMessage listen")
    if (!ws)
      return;
    const text: string = await ev.data.text()
    const recv: socketRecv = await JSON.parse(text);
    // tipClientLog(recv);
    const send: socketSend = { type: recv.type, sendForm: userInfo };

    if (recv.type == 'my_info')
      return client_socket_on_msg_my_info({ ws, recv, send }, setUserInfo)
  })

  /**
   * @note ws í˜ì´ì§€ì„¤ì •
   * @tip onload ì™€ unloadë¥¼ ê°ì§€í•˜ì—¬ eventlistenerë¥¼ ì„¤ì •í•©ë‹ˆë‹¤
   */
  useEffect(() => {
    if (ws) {
      ws.addEventListener('open', onOpen)
      ws.addEventListener('message', onMessage);
      ws.addEventListener('error', onError);
      ws.addEventListener('close', onClose);
      return () => {
        ws.removeEventListener('open', onOpen);
        ws.removeEventListener('message', onMessage);
        ws.removeEventListener('error', onError);
        ws.removeEventListener('close', onClose);
      }
    }
  }, [onOpen, onMessage, onError, onClose, ws])

  return (
    <div className=' w-full h-full flex flex-col'>
      <div>{userInfo.id}</div>
      <div>{userInfo.nickname}</div>
    </div>
  )
}

```

ì´ì œ ì„œë²„ìª½\ 
ì„œë²„ì—ì„œëŠ” onOPENì´ë¼ëŠ” typeì„ ê°€ì§„ ë©”ì„¸ì§€ê°€ ì˜¤ë©´ socket id ë¥¼ ë‹´ì•„ ì „ì†¡í•´ ì£¼ëŠ” ì½”ë“œë¥¼ ì§œë³´ì\

ğŸ  server licenses message controll
```jsx 
client.on('message', async (message) => {
  const socket_id = request.headers['sec-websocket-key'];
  if (!socket_id)
    return errorServerLog("[api/ws] message block!", "can't find sec-websocket-key");

  const msg = message.toString()
  const send: socketSend = await JSON.parse(msg);
  const recv: socketRecv = { type: send.type, recvFrom: send.sendForm };

  if ('onOpen' == send.type) {
    const newUser: userInfo = { id: socket_id, nickname: 'No nickname' }
    userlist.set(socket_id, { ...newUser })
    props.recv.recvFrom = newUser
    props.client.send(JSON.stringify(props.recv satisfies socketRecv), { binary: true });
  }
});
```

ì´ëŸ¬í•œ ì½”ë“œë¡œ ì–‘ë°©í–¥ í†µì‹ ì„ í•´ì¤„ ìˆ˜ ìˆë‹¤


ì—¬ê¸°ì„œ ì˜¤ëŠ” ë©”ì„¸ì§€ëŠ” ë°”ì´ë„ˆë¦¬ì½”ë“œ([Blob]Binary Large Object)ë¡œ ì „ì†¡í•´ì£¼ê¸° ë•Œë¬¸ì— ì½˜ì†”ì„ ì°ì–´ë³´ë©´\
16ì§„ìˆ˜ì½”ë“œë¡œ ë°ì´í„°ê°€ ì˜¤ëŠ”ê±¸ ë³¼ ìˆ˜ ìˆë‹¤.\
ì´ëŸ¬í•œ ë°ì´í„°ë¥¼ textë¡œ ë°”ê¾¸ê³  ì‚¬ìš©í•  ìˆ˜ ìˆì§€ë§Œ ì¢€ë” í¸í•˜ê²Œ ì‚¬ìš©í•˜ê¸°ìœ„í•´ jsonìœ¼ë¡œ ë¬¶ì–´ ì „ì†¡í•˜ê³  ë‹¤ì‹œ ë¬¶ìœ¼ë©° map(dic)í˜•íƒœì˜ ë°ì´í„°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤
> [!WARNING]
> blobë¥¼ ë³€í™˜í•˜ëŠ” ê³¼ì •ì€ ë°ì´í„° ì „ì†¡ ìì²´ê°€ ëŠë ¤ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br/>
> ì´ëŸ¬í•œ ë°©ë²•ì„ í•´ê²°í•˜ê¸° ìœ„í•´ blobìì²´ë¥¼ ìˆ˜ì •í•˜ì§€ì•Šê³  clientë”´ì—ì„œ ì¼ì •í•œ í¬ê¸°ë¡œ ì˜ë¼ ì „ì†¡í›„ <br/>
> í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë‹¤ ë°›ì•„ í•©ì³ ë¡œì§ì„ êµ¬ì„±í•˜ëŠ” ê²ƒë„ ì¢‹ì€ ë°©ë²•ì´ë¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ë‹¨.. ì„œë²„ì—ì„œ ë°ì´í„° ì²˜ë¦¬ëŠ” ë¶ˆê°€ëŠ¥í•´ ì§„ë‹¤)


### ì „ì±„ì ì¸ ì½”ë“œ

ğŸ ì„œë²„

```jsx
// app/api/ws/route.ts (can be any route file in the app directory)
import ws from 'ws'
import http from 'http'
import { NextRequest, NextResponse } from "next/server";
import { socket_close_safe, socket_connect_new_user, socket_connect_old_user, socket_send_msg, socket_update_user } from '@/lib/socket/server_msg_controll';
import { errorServerLog, importantServerLog, } from '@/lib/log/server_logger';


let userlist = new Map<string, userInfo | undefined>();
let socketlist = new Map<string, ws.WebSocket | undefined>();

export function SOCKET(
  client: ws.WebSocket,
  request: http.IncomingMessage,
  server: ws.WebSocketServer,
) {
  importantServerLog('A client connected!');
  const socket_id = request.headers['sec-websocket-key'];
  if (!socket_id)
    return;
  userlist.set(socket_id, { id: socket_id, nickname: 'No nickname' });
  socketlist.set(socket_id, client)

  /**
   * @note open ë¦¬ìŠ¤ë„ˆ
   * @breif ì‘ë™í•˜ì§€ ì•ŠìŒ
   */
  client.on('open', () => {
    importantServerLog('client open')
  })

  /**
   * @note error ë¦¬ìŠ¤ë„ˆ
   */
  client.on('error', () => {
    importantServerLog('client Error')
  })

  /**
   * @note close ë¦¬ìŠ¤ë„ˆ
   */
  client.on('close', () => {
    importantServerLog('A client disconnected!');
    const socket_id = request.headers['sec-websocket-key'];
    if (!socket_id)
      return errorServerLog("[api/ws] close block!", "can't find sec-websocket-key");
    socket_close_safe({
      client, server,
      send: { type: "user_out", sendForm: { id: socket_id } },
      recv: { type: "user_out", recvFrom: { id: socket_id } }
    }, socket_id, userlist);
  });

  /**
   * @note message ë¦¬ìŠ¤ë„ˆ
   */
  client.on('message', async (message) => {
    const socket_id = request.headers['sec-websocket-key'];
    if (!socket_id)
      return errorServerLog("[api/ws] message block!", "can't find sec-websocket-key");

    const msg = message.toString()
    const send: socketSend = await JSON.parse(msg);
    const recv: socketRecv = { type: send.type, recvFrom: send.sendForm };

    if ('onOpen' == send.type)
      return socket_connect_new_user({ client, server, send, recv }, socket_id, userlist);
    if ('update_user' == send.type)
      return socket_update_user({ client, server, send, recv }, userlist);
    if ("old_user" == send.type && send.sendTo)
      return socket_connect_old_user({ client, server, send, recv }, socketlist);
    if ("msg" == send.type)
      return socket_send_msg({ client, server, send, recv });

  });

}

export function GET(req: NextRequest) {
  importantServerLog("api[ws] : ", req)
  return NextResponse.json({
    socket: "next-ws",
    message: "here is for connect WebSocket with next-ws"
  })
}
```

ğŸ í´ë¼ì´ì–¸íŠ¸ 
```jsx
// page.tsx
'use client';

import React, { useCallback, useEffect, useRef, useState } from 'react';
import { useWebSocket } from 'next-ws/client';
import { DEFAULT_SOCKET_URL } from '@/routes';
import { client_socket_on_msg_my_info, client_socket_on_msg_new_user, client_socket_on_msg_old_user, client_socket_on_msg_update_user, client_socket_on_msg_leave_user } from '@/lib/socket/client_msg_controll';
import { errorClientLog, importantClientLog, noteClientLog, tipClientLog } from '@/lib/log/client_logger';
import SocketDashBoard from '@/components/socket/SocketDashboard';
import SocketInfo from '@/components/socket/SocketInfo';

export default function Page() {

  /*** socket setting start ***/
  const [ws, setWs] = useState<WebSocket | null>(useWebSocket());
  const [userInfo, setUserInfo] = useState<userInfo>({ id: '', nickname: 'No Nickname' });
  const [userList, setUserList] = useState<userInfo[]>([]);
  const [tryConnect, setTryConnect] = useState(0);

  /**
   * @props ev: Event
   * @socket on open
   * @note ì ‘ì† ì„±ê³µì‹œ ì „ë‹¬í•˜ëŠ” ë©”ì„¸ì§€ ì…ë‹ˆë‹¤.
   * - ì„œë²„ì—ì„œ socket idë¥¼ ìš”ì²­ í•©ë‹ˆë‹¤.
   */
  const onOpen = useCallback((ev: Event) => {
    importantClientLog("onOpen listen", ev);
    if (!ws)
      return;
    ws.send(JSON.stringify({ type: 'onOpen', sendForm: { id: '' } } satisfies socketSend))
    setTryConnect(0);
  }, [ws]);

  /**
   * @props ev: Event
   * @socket on error
   * @note ì—ëŸ¬ ë©”ì„¸ì§€ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤
   * - socketì˜ id ê°€ ì—†ì„ë•Œ
   * - ì„œë²„ì™€ í†µì‹ ì´ ì•ˆë ë•Œ
   */
  const onError = useCallback((ev: Event) => {
    importantClientLog("onError listen", ev)
  }, []);

  /**
   * @props ev: CloseEvent
   * @socket on close
   * @note ì—ëŸ¬ ë©”ì„¸ì§€ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤
   * - socketì˜ id ê°€ ì—†ì„ë•Œ
   * - ì„œë²„ì™€ í†µì‹ ì´ ì•ˆë ë•Œ
   */
  const onClose = useCallback((ev: CloseEvent) => {
    importantClientLog("onClose listen", ev)
    setTimeout(() => {
      if (tryConnect > 5)
        return errorClientLog("can't Reconnect server", "close socket");
      noteClientLog('Try Reconnect server', tryConnect)
      setTryConnect(tryConnect + 1);
      setWs(new WebSocket(DEFAULT_SOCKET_URL));
    }, 1000);
  }, [tryConnect])

  /**
   * @props ev: MessageEvent<Blob>
   * @socket on message
   * @note ìˆ˜ì‹  ë©”ì„¸ì§€ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤
   * - Connect Server
   * @need blobì„ ì‚¬ìš©í•˜ì—¬ ë‚˜ì¤‘ì— ë°ì´í„° ìª¼ê°œ ë³´ë‚´ê¸° í•„ìš”
   */
  const onMessage = useCallback(async (ev: MessageEvent<Blob>) => {
    importantClientLog("onMessage listen")
    if (!ws)
      return;
    const text: string = await ev.data.text()
    const recv: socketRecv = await JSON.parse(text);
    // tipClientLog(recv);
    const send: socketSend = { type: recv.type, sendForm: userInfo };

    if (recv.type == 'my_info')
      return client_socket_on_msg_my_info({ ws, recv, send }, setUserInfo)
    if (recv.type == 'new_user')
      return client_socket_on_msg_new_user({ ws, recv, send }, userList, setUserList)
    if (recv.type == 'old_user')
      return client_socket_on_msg_old_user({ ws, recv, send }, userList, setUserList)
    if (recv.type == 'update_user')
      return client_socket_on_msg_update_user({ ws, recv, send }, userList, setUserList)
    if (recv.type == 'leave_user')
      return client_socket_on_msg_leave_user({ ws, recv, send }, userList, setUserList)
  }, [userInfo, userList, ws]);

  /**
   * @note ws í˜ì´ì§€ì„¤ì •
   * @tip onload ì™€ unloadë¥¼ ê°ì§€í•˜ì—¬ eventlistenerë¥¼ ì„¤ì •í•©ë‹ˆë‹¤
   */
  useEffect(() => {
    if (ws) {
      ws.addEventListener('open', onOpen)
      ws.addEventListener('message', onMessage);
      ws.addEventListener('error', onError);
      ws.addEventListener('close', onClose);
      return () => {
        ws.removeEventListener('open', onOpen);
        ws.removeEventListener('message', onMessage);
        ws.removeEventListener('error', onError);
        ws.removeEventListener('close', onClose);
      }
    }
  }, [onOpen, onMessage, onError, onClose, ws])

  /*** socket setting done ***/

  return (
    <div className=' w-full h-full flex flex-col'>
      <SocketInfo userInfo={userInfo} />
      <SocketDashBoard userList={userList} ></SocketDashBoard>
    </div>
  )
}
```

ë”ìì„¸í•œ ì½”ë“œëŠ” ì•„ë˜ ë§í¬ë¥¼ ì°¸ê³ í•˜ê¸° ë°”ë€ë‹¤

ğŸ”— ë§í¬ : https://github.com/liebespaar93/r3f_server

### ì°¸ê³ ì‚¬í•­

> [!TIP]
> nextjsì—ì„œ socket ì‚¬ìš©ì´ ì•ˆë˜ëŠ” í† ë¡ <br/>
> ë¬´ì–¸ê°€ ì§„í–‰ì¤‘ì´ë‹¤ ë­”ê°€ ë°”ë€Œë ¤ë‚˜? <br/>
> https://github.com/vercel/next.js/discussions/58698

> [!TIP]
> ìì„¸í•œ nodejsì˜ êµ¬ë™ ë°©ì‹ì´ ê¶ê¸ˆí•˜ë©´ <br/>
> [nodejs ê³µì‹ë¬¸ì„œ](https://nodejs.org/api/worker_threads.html#class-messageport)
 



